// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
  // url      = "mongodb+srv://diago:CnbAhamGnqXeb8qF@cluster0.zdxmf2n.mongodb.net/alloc?retryWrites=true&w=majority&appName=Cluster0"
}

// NEW MODEL: To store the sentences from the base corpus file.
model GlobalSentence {
  id   Int    @id @map("_id")
  text String

  @@map("global_sentences")
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  projects       Project[]
  personalCorpus PersonalCorpus[]
  corpusIndex    CorpusIndex[] // UPDATED: Relation to the new unified index
  quizSessions   QuizSession[]
  analytics      UserAnalytics[]

  @@map("users")
}

// UPDATED: This model now handles BOTH global and personal indexes.
model CorpusIndex {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  baseWord    String
  variants    String[]
  sentenceIds String[] // Stores GlobalSentence IDs (as strings) or PersonalCorpus IDs

  // userId is optional. If null, it's a global entry.
  userId String? @db.ObjectId

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  // updatedAt DateTime @updatedAt

  @@unique([baseWord, userId])
  @@map("corpus_indices")
}

model PersonalCorpus {
  id        String       @id @default(auto()) @map("_id") @db.ObjectId
  sentence  String
  words     String // JSON array of words
  baseWords String // JSON array of base words (normalized)
  source    CorpusSource @default(manual)
  createdAt DateTime     @default(now())

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.ObjectId

  @@map("personal_corpus")
}

// Other models (Project, ProjectSentence, etc.) remain the same...

model Project {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  content     String        @default("")
  mode        ProjectMode   @default(freestyle)
  status      ProjectStatus @default(active)
  wordCount   Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  isEnforced  Boolean       @default(false)
  enforcedAt  DateTime?

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.ObjectId

  sentences      ProjectSentence[]
  personalCorpus String[]
  stats          Json              @default("{\"totalSentences\": 0, \"completeSentences\": 0, \"partialSentences\": 0, \"unknownWords\": 0, \"completionRate\": 0}")
  sessions       WritingSession[]

  @@map("projects")
}

model ProjectSentence {
  id        String         @id @default(auto()) @map("_id") @db.ObjectId
  text      String
  position  Int
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  status    SentenceStatus @default(partial)

  // Relations
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String  @db.ObjectId
  analysis  Json?

  @@map("project_sentences")
}

model WritingSession {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  startedAt  DateTime  @default(now())
  endedAt    DateTime?
  wordsAdded Int       @default(0)

  // Relations
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String  @db.ObjectId

  @@map("writing_sessions")
}

model QuizSession {
  id             String         @id @default(auto()) @map("_id") @db.ObjectId
  score          Int            @default(0)
  totalQuestions Int            @default(0)
  correctAnswers Int            @default(0)
  timeSpent      Int            @default(0) // in seconds
  difficulty     QuizDifficulty @default(medium)
  createdAt      DateTime       @default(now())

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.ObjectId

  @@map("quiz_sessions")
}

model UserAnalytics {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  date         DateTime @default(now())
  wordsWritten Int      @default(0)
  correctWords Int      @default(0)
  variantWords Int      @default(0)
  unknownWords Int      @default(0)
  timeSpent    Int      @default(0) // in seconds

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.ObjectId

  @@unique([userId, date])
  @@map("user_analytics")
}

enum ProjectMode {
  freestyle
  guided
}

enum ProjectStatus {
  active
  completed
  archived
}

enum SentenceStatus {
  partial
  complete
  error
}

enum CorpusSource {
  manual
  project
  import
}

enum QuizDifficulty {
  easy
  medium
  hard
}
